// SCREENS Database Schema
// Manages videos, displays, playlists, and playback coordination

generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Video metadata stored in database, actual files in Vercel Blob
model Video {
  id          String   @id @default(cuid())
  title       String
  description String?
  blobUrl     String   // Vercel Blob storage URL
  thumbnailUrl String?  // Optional thumbnail URL
  duration    Int?     // Duration in seconds
  fileSize    Int?     // File size in bytes
  mimeType    String   // Video MIME type (video/mp4, etc.)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  playlistItems PlaylistItem[]

  @@index([createdAt])
}

// Physical display devices
model Display {
  id           String    @id @default(cuid())
  name         String
  token        String    @unique // Unique authentication token
  description  String?
  isActive     Boolean   @default(true)
  showControls Boolean   @default(true) // Show UI controls/furniture on display
  lastSeenAt   DateTime? // Last connection timestamp
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  playlist Playlist? // Legacy 1:1 relationship (will be removed)
  playlists DisplayPlaylist[]

  @@index([token])
  @@index([isActive, lastSeenAt])
}

// Playlist that can be assigned to multiple displays
model Playlist {
  id           String       @id @default(cuid())
  displayId    String?      @unique // Legacy field (will be removed)
  name         String       @default("")
  description  String?
  playbackMode PlaybackMode @default(SEQUENCE)
  videoGap     Int          @default(0) // Gap in seconds between videos
  isActive     Boolean      @default(true)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  // Relations
  display  Display?          @relation(fields: [displayId], references: [id], onDelete: Cascade) // Legacy (will be removed)
  displays DisplayPlaylist[]
  items    PlaylistItem[]

  @@index([displayId])
  @@index([name])
}

// Many-to-many relationship between displays and playlists
model DisplayPlaylist {
  id         String   @id @default(cuid())
  displayId  String
  playlistId String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  display  Display  @relation(fields: [displayId], references: [id], onDelete: Cascade)
  playlist Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)

  @@unique([displayId, playlistId]) // A playlist can only be assigned once to a display
  @@index([displayId])
  @@index([playlistId])
}

// Individual videos in a playlist with ordering
model PlaylistItem {
  id         String   @id @default(cuid())
  playlistId String
  videoId    String
  position   Int      // Order in playlist (0-indexed)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  playlist Playlist @relation(fields: [playlistId], references: [id], onDelete: Cascade)
  video    Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([playlistId, videoId]) // Video can only appear once per playlist
  @@unique([playlistId, position]) // Each position is unique per playlist
  @@index([playlistId, position])
}

// Playback mode enumeration
enum PlaybackMode {
  LOOP     // Loop through playlist continuously
  SEQUENCE // Play through once and stop
  MANUAL   // Wait for manual trigger from controller
}
